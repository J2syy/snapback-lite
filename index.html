<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
<title>SNAPBACK Photo Booth</title>

<style>
/* ===== HIGH-END STUDIO DESIGN TOKENS ===== */
:root {
  --bg: #f4f4f5; /* Very soft zinc off-white */
  --surface: #ffffff;
  --dark: #18181b; /* Pitch zinc black */
  --text-muted: #a1a1aa;
  --text-main: #27272a;
  --border: #e4e4e7;
  --radius-lg: 32px;
  --radius-md: 20px;
  --radius-sm: 12px;
  --shadow-soft: 0 12px 32px -12px rgba(0, 0, 0, 0.08);
  --shadow-float: 0 24px 48px -12px rgba(0, 0, 0, 0.15);
  --theme-color: #ffffff; 
}

* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", "Helvetica Neue", Helvetica, sans-serif;
  -webkit-tap-highlight-color: transparent;
  font-smooth: always;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 24px 16px;
  overflow-x: hidden;
}

/* ===== MINIMALIST HEADER ===== */
header {
  text-align: center;
  margin-bottom: 24px;
  width: 100%;
  max-width: 420px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}

.brand {
  text-align: left;
}

h1 {
  margin: 0;
  letter-spacing: -1px;
  font-size: 20px;
  font-weight: 800;
  color: var(--dark);
}

.tagline {
  font-size: 10px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-top: 4px;
}

.admin-btn {
  background: transparent;
  border: none;
  color: var(--text-muted);
  width: 32px;
  height: 32px;
  font-size: 18px;
  cursor: pointer;
  transition: color 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}
.admin-btn:active {
  color: var(--dark);
}

/* ===== SLEEK VIEWPORT ===== */
.view-container {
  position: relative;
  width: 100%;
  max-width: 420px;
  flex: 1; 
  min-height: 0; 
  border-radius: var(--radius-lg);
  background: #000000;
  box-shadow: var(--shadow-float);
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 12px; 
  border: 1px solid rgba(0,0,0,0.05);
}

/* BULLETPROOF SIZING TRICK */
#livePrintOut {
  width: 2000px; 
  max-width: 100%;
  max-height: 100%;
  background: var(--theme-color);
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  transition: background 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), aspect-ratio 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
  container-type: inline-size;
  position: relative;
  /* Adds a tiny physical "paper" border to the print out */
  box-shadow: 0 0 0 1px rgba(0,0,0,0.05);
  border-radius: 2px;
}

#liveGrid {
  flex: 1;
  display: grid;
  min-height: 0; 
  position: relative;
  z-index: 1;
}

.grid-slot {
  background: #f4f4f5; 
  position: relative;
  overflow: hidden;
  border-radius: 1px;
}

.grid-slot video, .grid-slot img {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  object-fit: cover; 
  z-index: 1;
}

#videoOverlay {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
  transition: background 0.4s ease;
  z-index: 2;
}

#liveText {
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
  overflow: hidden;
  position: relative;
  z-index: 2;
}

.event-title {
  font-weight: 800;
  font-size: 5cqi; 
  letter-spacing: -0.5px;
  margin: 0;
  text-transform: uppercase;
  transition: color 0.4s ease;
}

.event-subtitle {
  font-size: 2.2cqi; 
  margin-top: 3px;
  font-weight: 500;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  transition: color 0.4s ease;
}

/* Sticker Layer */
#stickersContainer {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
  z-index: 5;
  overflow: hidden;
}
.sticker {
  position: absolute;
  transform-origin: center;
  display: flex;
  align-items: center;
  justify-content: center;
  filter: drop-shadow(0 4px 12px rgba(0,0,0,0.1));
}

#flashOverlay {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: white;
  opacity: 0;
  pointer-events: none;
  z-index: 10;
  border-radius: var(--radius-lg);
}

/* ===== SEQUENCE UI ===== */
#sequenceIndicator {
  position: absolute;
  top: 24px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.4);
  color: white;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  z-index: 20;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

#countdownOverlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 140px;
  font-weight: 300;
  color: white;
  text-shadow: 0 10px 40px rgba(0,0,0,0.5);
  z-index: 20;
  transition: transform 0.1s ease;
  font-variant-numeric: tabular-nums;
}

/* ===== REFINED CONTROLS PANEL ===== */
.control-panel {
  width: 100%;
  max-width: 420px;
  background: var(--surface);
  border-radius: var(--radius-lg);
  padding: 20px;
  box-shadow: var(--shadow-soft);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 16px;
  transition: opacity 0.3s ease;
  flex-shrink: 0;
}

.options-menu {
  display: flex;
  flex-direction: column;
  gap: 16px;
  transition: all 0.3s ease;
}

.options-menu.collapsed {
  display: none;
}

.toggle-menu-btn {
  background: transparent;
  border: none;
  font-size: 10px;
  font-weight: 700;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: color 0.2s ease;
  align-self: center;
}
.toggle-menu-btn:active {
  color: var(--dark);
}

.scroll-row {
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  gap: 8px;
  padding-bottom: 4px;
  -ms-overflow-style: none;
  scrollbar-width: none;
  mask-image: linear-gradient(to right, black 90%, transparent 100%);
  -webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%);
}
.scroll-row::-webkit-scrollbar { display: none; }

.row-label {
  font-size: 10px;
  font-weight: 600;
  color: #a1a1aa; /* Zinc 400 */
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-left: 2px;
  margin-bottom: -6px;
}

/* Minimalist Pills */
button.opt-btn {
  padding: 10px 16px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: transparent;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  color: var(--text-main);
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}

button.opt-btn.active {
  background: var(--dark);
  color: white;
  border-color: var(--dark);
  font-weight: 600;
}

.action-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 4px;
  padding: 0 8px;
}

.icon-btn {
  background: #f4f4f5;
  border: none;
  color: var(--text-main);
  width: 48px;
  height: 48px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
  flex-shrink: 0;
}
.icon-btn:active {
  transform: scale(0.9);
  background: #e4e4e7;
}
.icon-btn.active {
  background: var(--dark);
  color: white;
}

/* Elegant Mechanical Shutter */
button.shutter {
  width: 72px;
  height: 72px;
  flex-shrink: 0;
  border-radius: 50%;
  background: transparent;
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  position: relative;
  transition: border-color 0.2s ease;
  padding: 0;
}
button.shutter::after {
  content: '';
  width: 58px;
  height: 58px;
  background: var(--dark);
  border-radius: 50%;
  transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
}
button.shutter:active {
  border-color: #d4d4d8;
}
button.shutter:active::after { 
  transform: scale(0.9); 
}
button.shutter:disabled { opacity: 0.3; cursor: not-allowed; }

/* ===== ADMIN MODAL ===== */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.modal-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.modal-content {
  background: white;
  padding: 32px 24px;
  border-radius: var(--radius-lg);
  width: 90%;
  max-width: 320px;
  box-shadow: var(--shadow-float);
  text-align: center;
}

.modal-content h3 { margin: 0 0 24px 0; font-size: 18px; font-weight: 700; color: var(--dark); letter-spacing: -0.5px; }

.modal-content input[type="text"], 
.modal-content input[type="password"] {
  width: 100%;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 500;
  background: var(--bg);
  color: var(--text-main);
  transition: all 0.2s ease;
}
.modal-content input:focus { outline: none; border-color: var(--dark); background: white; }
.modal-content input::placeholder { color: var(--text-muted); font-weight: 400; }

.btn-primary {
  width: 100%;
  padding: 16px;
  background: var(--dark);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 12px;
  transition: transform 0.2s ease;
}
.btn-primary:active {
  transform: scale(0.98);
}

/* Upload Actions Container */
#uploadControls {
  display: flex;
  gap: 12px;
  width: 100%;
  max-width: 420px;
  margin-top: 0;
  flex-shrink: 0;
}
#uploadControls button {
  flex: 1;
  padding: 16px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: transform 0.2s ease;
}
#uploadControls button:active { transform: scale(0.98); }
#uploadBtn { 
  background: var(--dark); 
  color: white; 
}
#retakeBtn { 
  background: white; 
  color: var(--dark); 
  border: 1px solid var(--border);
}

/* Status Box */
#statusMessage {
  margin-top: 12px;
  padding: 16px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  text-align: center;
  width: 100%;
  max-width: 420px;
}
#statusMessage.loading { background: #fafafa; color: var(--text-muted); border: 1px solid var(--border); }
#statusMessage.success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
#statusMessage.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
.hidden { display: none !important; }
</style>
</head>

<body>

<header>
  <div class="brand">
    <h1>SNAPBACK</h1>
    <div class="tagline">Studio Edition</div>
  </div>
  <button class="admin-btn" id="openAdminBtn" title="Admin Settings">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
  </button>
</header>

<div class="view-container" id="viewContainer">
  
  <div id="livePrintOut">
    <div id="stickersContainer"></div>
    <div id="liveGrid"></div>
    <div id="liveText">
      <div class="event-title" id="overlayTitle"></div>
      <div class="event-subtitle" id="overlaySubtitle"></div>
    </div>
  </div>

  <div id="sequenceIndicator" class="hidden">Photo 1 of 4</div>
  <div id="countdownOverlay" class="hidden">3</div>
  <div id="flashOverlay"></div>
  
  <canvas id="canvas" class="hidden"></canvas>
  <video id="video" autoplay playsinline class="hidden"></video>
  <div id="videoOverlay" class="hidden"></div>
</div>

<div class="control-panel" id="mainControls">
  
  <button class="toggle-menu-btn" id="toggleMenuBtn">Hide Menu</button>
  
  <div id="optionsMenu" class="options-menu">
    <div class="row-label">Layout</div>
    <div class="scroll-row" id="layoutControls"></div>

    <div class="row-label">Timer</div>
    <div class="scroll-row" id="timerControls"></div>

    <div class="row-label">Film Border</div>
    <div class="scroll-row" id="themeControls"></div>

    <div class="row-label">Processing</div>
    <div class="scroll-row" id="filterControls"></div>
  </div>

  <div class="action-row">
    <button class="icon-btn" id="flashBtn" title="Toggle Flash">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
    </button>
    <button class="shutter" id="shutter"></button>
    <button class="icon-btn" id="flipBtn" title="Flip Camera">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
    </button>
  </div>
</div>

<div id="uploadControls" class="hidden">
  <button id="retakeBtn">Retake</button>
  <button id="uploadBtn">Upload to Gallery</button>
</div>

<div id="statusMessage" class="hidden"></div>

<div class="modal-overlay" id="adminModal">
  <div class="modal-content">
    <h3>Configuration</h3>
    
    <div id="adminLoginView">
      <input type="password" id="adminPin" placeholder="Enter security PIN" inputmode="numeric">
      <button class="btn-primary" id="loginBtn">Unlock</button>
    </div>

    <div id="adminSettingsView" class="hidden">
      <input type="text" id="inputTitle" placeholder="Event Name" maxlength="25">
      <input type="text" id="inputSubtitle" placeholder="Event Subtitle" maxlength="35">
      <button class="btn-primary" id="saveAdminBtn">Save Config</button>
    </div>
  </div>
</div>

<script>
/* ================= GLOBAL STATE ================= */
let EVENT_NAME = localStorage.getItem("snapback_event_name") || "Studio Session";
let EVENT_DATE = localStorage.getItem("snapback_event_date") || "Captured today";
const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxX9wMOWPLZrimEpvdojQsOh6ESW8kgBw3BK_qYX6VJC8s05tKgYS7BqrnULgrFS5zB/exec";

let stream = null;
let facingMode = "environment";
let flashEnabled = false;
let optionsOpen = true;
const ADMIN_PIN = "1234"; 
let capturedPhotos = []; 

/* ================= CONFIGURATIONS ================= */
// Set all crops to 'portrait' (3:4 aspect ratio) to retain a tall mobile frame feel
const LAYOUTS = {
  single: { name: "1 Photo", count: 1, cols: 1, rows: 1, crop: 'portrait' },
  grid2:  { name: "2 Grid",  count: 2, cols: 2, rows: 1, crop: 'portrait' },
  strip2: { name: "2 Strip", count: 2, cols: 1, rows: 2, crop: 'portrait' },
  strip3: { name: "3 Strip", count: 3, cols: 1, rows: 3, crop: 'portrait' },
  strip4: { name: "4 Strip", count: 4, cols: 1, rows: 4, crop: 'portrait' },
  grid4:  { name: "4 Grid",  count: 4, cols: 2, rows: 2, crop: 'portrait' },
  strip8: { name: "8 Strip", count: 8, cols: 1, rows: 8, crop: 'portrait' },
  grid8:  { name: "8 Grid",  count: 8, cols: 2, rows: 4, crop: 'portrait' }
};

const TIMERS = {
  t3:  { name: "3s Timer", value: 3 },
  t5:  { name: "5s Timer", value: 5 },
  off: { name: "Off", value: 0 }
};

const FRAMES = {
  polaroid: { name: "Gallery White", bgFill: "#ffffff", textCol: "#18181b" },
  midnight: { name: "Onyx Black", bgFill: "#09090b", textCol: "#ffffff" },
  kraft:    { name: "Studio Kraft", bgFill: "#e7e5e4", textCol: "#1c1917" },
  blue:     { name: "Cyanotype", bgFill: "#f0f9ff", textCol: "#0369a1" },
  stickers: { 
    name: "Kawaii ðŸŽ€", 
    bgFill: "#fdf2f8", 
    textCol: "#be185d",
    stickers: [
      { emoji: "ðŸ’–", left: "8%", top: "8%", size: 0.1, angle: -15 },
      { emoji: "âœ¨", right: "10%", top: "25%", size: 0.08, angle: 10 },
      { emoji: "ðŸŽ€", right: "6%", bottom: "25%", size: 0.12, angle: -20 },
      { emoji: "ðŸŒ¸", left: "6%", bottom: "18%", size: 0.1, angle: 15 },
      { emoji: "ðŸ§¸", right: "82%", top: "65%", size: 0.09, angle: 5 },
      { emoji: "ðŸ’", left: "85%", top: "45%", size: 0.08, angle: -10 }
    ]
  }
};

const FILTERS = {
  none:    { name: "Raw", css: "none", overlay: "transparent", vignette: false },
  bw:      { name: "Noir", css: "grayscale(1) contrast(1.1)", overlay: "transparent", vignette: true },
  vintage: { name: "Portra", css: "sepia(0.3) contrast(1.1) brightness(0.95) saturate(1.1)", overlay: "transparent", vignette: true },
  cool:    { name: "Cinematic", css: "saturate(0.85) contrast(1.05)", overlay: "rgba(0, 50, 200, 0.05)", vignette: false },
  warm:    { name: "Golden", css: "sepia(0.25) saturate(1.2)", overlay: "rgba(255, 120, 0, 0.03)", vignette: false },
  soft:    { name: "Soft Glow", css: "blur(0.5px) brightness(1.05) contrast(0.95)", overlay: "rgba(255, 255, 255, 0.05)", vignette: false },
  cyan:    { name: "Chrome", css: "sepia(0.5) hue-rotate(180deg) saturate(1.2)", overlay: "rgba(0, 100, 150, 0.05)", vignette: true }
};

let currentLayoutKey = "single";
let currentTimerKey = "t3";
let currentFrameKey = "polaroid";
let currentFilterKey = "none";

/* ================= DOM ELEMENTS ================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const videoOverlay = document.getElementById("videoOverlay");
const flashOverlay = document.getElementById("flashOverlay");
const countdownOverlay = document.getElementById("countdownOverlay");
const sequenceIndicator = document.getElementById("sequenceIndicator");

const livePrintOut = document.getElementById("livePrintOut");
const liveGrid = document.getElementById("liveGrid");
const stickersContainer = document.getElementById("stickersContainer");
const overlayTitle = document.getElementById("overlayTitle");
const overlaySubtitle = document.getElementById("overlaySubtitle");
const liveText = document.getElementById("liveText");

const layoutControls = document.getElementById("layoutControls");
const timerControls = document.getElementById("timerControls");
const themeControls = document.getElementById("themeControls");
const filterControls = document.getElementById("filterControls");
const mainControls = document.getElementById("mainControls");
const uploadControls = document.getElementById("uploadControls");

const toggleMenuBtn = document.getElementById("toggleMenuBtn");
const optionsMenu = document.getElementById("optionsMenu");

const shutterBtn = document.getElementById("shutter");
const flipBtn = document.getElementById("flipBtn");
const flashBtn = document.getElementById("flashBtn");
const retakeBtn = document.getElementById("retakeBtn");
const uploadBtn = document.getElementById("uploadBtn");

const openAdminBtn = document.getElementById("openAdminBtn");
const adminModal = document.getElementById("adminModal");
const adminPin = document.getElementById("adminPin");
const loginBtn = document.getElementById("loginBtn");
const adminLoginView = document.getElementById("adminLoginView");
const adminSettingsView = document.getElementById("adminSettingsView");
const saveAdminBtn = document.getElementById("saveAdminBtn");

const inputTitle = document.getElementById("inputTitle");
const inputSubtitle = document.getElementById("inputSubtitle");

/* ================= INITIALIZATION ================= */
function initUI() {
  // Layout Options
  Object.keys(LAYOUTS).forEach(key => {
    const btn = document.createElement("button");
    btn.className = "opt-btn" + (key === currentLayoutKey ? " active" : "");
    btn.textContent = LAYOUTS[key].name;
    btn.onclick = () => {
      currentLayoutKey = key;
      document.querySelectorAll('#layoutControls button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyLayout(); 
    };
    layoutControls.appendChild(btn);
  });

  // Timer Options
  Object.keys(TIMERS).forEach(key => {
    const btn = document.createElement("button");
    btn.className = "opt-btn" + (key === currentTimerKey ? " active" : "");
    btn.textContent = TIMERS[key].name;
    btn.onclick = () => {
      currentTimerKey = key;
      document.querySelectorAll('#timerControls button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
    timerControls.appendChild(btn);
  });

  // Theme Options
  Object.keys(FRAMES).forEach(key => {
    const btn = document.createElement("button");
    btn.className = "opt-btn" + (key === currentFrameKey ? " active" : "");
    btn.textContent = FRAMES[key].name;
    btn.onclick = () => {
      currentFrameKey = key;
      document.querySelectorAll('#themeControls button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyTheme(); 
    };
    themeControls.appendChild(btn);
  });

  // Filter Options
  Object.keys(FILTERS).forEach(key => {
    const btn = document.createElement("button");
    btn.className = "opt-btn" + (key === currentFilterKey ? " active" : "");
    btn.textContent = FILTERS[key].name;
    btn.onclick = () => {
      currentFilterKey = key;
      document.querySelectorAll('#filterControls button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyLiveFilter(); 
    };
    filterControls.appendChild(btn);
  });

  applyAdminText();
  applyTheme();
  applyLayout();
  applyLiveFilter();
  startCamera();
}

/* ================= TOGGLE MENU ================= */
toggleMenuBtn.onclick = () => {
  optionsOpen = !optionsOpen;
  if (optionsOpen) {
    optionsMenu.classList.remove("collapsed");
    toggleMenuBtn.textContent = "Hide Menu";
  } else {
    optionsMenu.classList.add("collapsed");
    toggleMenuBtn.textContent = "Show Menu";
  }
};

/* ================= ADMIN LOGIC ================= */
openAdminBtn.onclick = () => {
  adminPin.value = '';
  adminLoginView.classList.remove('hidden');
  adminSettingsView.classList.add('hidden');
  adminModal.classList.add('active');
};

loginBtn.onclick = () => {
  if (adminPin.value === ADMIN_PIN) {
    adminLoginView.classList.add('hidden');
    adminSettingsView.classList.remove('hidden');
    inputTitle.value = EVENT_NAME;
    inputSubtitle.value = EVENT_DATE;
  } else {
    alert("Incorrect PIN");
  }
};

saveAdminBtn.onclick = () => {
  EVENT_NAME = inputTitle.value.trim() || "Studio Session";
  EVENT_DATE = inputSubtitle.value.trim() || "Captured today";
  
  // Save settings persistently
  localStorage.setItem("snapback_event_name", EVENT_NAME);
  localStorage.setItem("snapback_event_date", EVENT_DATE);
  
  applyAdminText();
  adminModal.classList.remove('active');
};

function applyAdminText() {
  overlayTitle.textContent = EVENT_NAME;
  overlaySubtitle.textContent = EVENT_DATE;
}

/* ================= LIVE PREVIEWS & GRID ================= */
function applyTheme() {
  const frame = FRAMES[currentFrameKey];
  document.documentElement.style.setProperty('--theme-color', frame.bgFill);
  overlayTitle.style.color = frame.textCol;
  
  // Dynamic subtle text color based on background darkness
  if(frame.bgFill === "#09090b") {
     overlaySubtitle.style.color = 'rgba(255,255,255,0.5)';
  } else {
     overlaySubtitle.style.color = 'rgba(0,0,0,0.4)';
  }
  
  // Render Stickers for Live Preview
  stickersContainer.innerHTML = '';
  if (frame.stickers) {
    frame.stickers.forEach(s => {
      const el = document.createElement('div');
      el.className = 'sticker';
      el.textContent = s.emoji;
      if (s.left) el.style.left = s.left;
      if (s.right) el.style.right = s.right;
      if (s.top) el.style.top = s.top;
      if (s.bottom) el.style.bottom = s.bottom;
      // Size dynamically scales using cqi relative to the livePrintOut container
      el.style.fontSize = `${s.size * 100}cqi`;
      el.style.transform = `rotate(${s.angle}deg)`;
      stickersContainer.appendChild(el);
    });
  }
}

function applyLiveFilter() {
  const f = FILTERS[currentFilterKey];
  video.style.filter = f.css;
  let bg = `linear-gradient(${f.overlay}, ${f.overlay})`;
  if (f.vignette) bg += `, radial-gradient(circle, transparent 35%, rgba(0,0,0,0.5) 120%)`;
  videoOverlay.style.background = bg;
}

function applyLayout() {
  const layout = LAYOUTS[currentLayoutKey];

  // Rescue the video feed before destroying the grid so the camera doesn't pause!
  const viewContainer = document.getElementById("viewContainer");
  if (video.parentNode !== viewContainer) viewContainer.appendChild(video);
  if (videoOverlay.parentNode !== viewContainer) viewContainer.appendChild(videoOverlay);

  liveGrid.innerHTML = ''; 
  
  // High-Res Print Dimensions
  const pW = 720;
  const pH = layout.crop === 'square' ? 720 : 960;
  const gap = 24; // Slimmer, elegant gap
  const outerPad = 32; // Tighter, refined padding
  const bottomSpace = 240; 

  const totalW = (outerPad * 2) + (pW * layout.cols) + (gap * (layout.cols - 1));
  const totalH = outerPad + bottomSpace + (pH * layout.rows) + (gap * (layout.rows - 1));
  
  // Enforce perfect aspect ratio visually 
  livePrintOut.style.aspectRatio = `${totalW} / ${totalH}`;

  // Native, foolproof CSS variable padding using CQI (Container Query Inline)
  const padCqi = (outerPad / totalW) * 100;
  const gapCqi = (gap / totalW) * 100;
  const bottomCqi = (bottomSpace / totalW) * 100;

  livePrintOut.style.padding = `${padCqi}cqi ${padCqi}cqi 0 ${padCqi}cqi`;
  liveGrid.style.gap = `${gapCqi}cqi`;
  
  liveText.style.height = `${bottomCqi}cqi`;
  liveText.style.flex = `0 0 ${bottomCqi}cqi`;

  liveGrid.style.gridTemplateColumns = `repeat(${layout.cols}, 1fr)`;
  liveGrid.style.gridTemplateRows = `repeat(${layout.rows}, 1fr)`;

  for (let i = 0; i < layout.count; i++) {
    const slot = document.createElement('div');
    slot.className = 'grid-slot';
    slot.id = `slot-${i}`;
    liveGrid.appendChild(slot);
  }

  const firstSlot = document.getElementById('slot-0');
  if (firstSlot) {
    video.classList.remove('hidden');
    videoOverlay.classList.remove('hidden');
    firstSlot.appendChild(video);
    firstSlot.appendChild(videoOverlay);
  }
}

/* ================= CAMERA CONTROL ================= */
async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: facingMode, width: { ideal: 1080 }, height: { ideal: 1440 } }
    });
    video.srcObject = stream;
    video.style.transform = facingMode === "user" ? "scaleX(-1)" : "scaleX(1)";
  } catch (err) {
    alert("Camera access is required for the studio booth to function.");
  }
}

flipBtn.onclick = () => {
  facingMode = facingMode === "environment" ? "user" : "environment";
  startCamera();
};

flashBtn.onclick = async () => {
  flashEnabled = !flashEnabled;
  flashBtn.classList.toggle("active", flashEnabled);
  
  if (stream) {
    const track = stream.getVideoTracks()[0];
    if (typeof track.getCapabilities === "function" && track.getCapabilities().torch) {
      try { await track.applyConstraints({ advanced: [{ torch: flashEnabled }] }); } catch(e){}
    }
  }
};

/* ================= SEQUENCE CAPTURE LOGIC ================= */
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function doCountdown(seconds) {
  countdownOverlay.classList.remove("hidden");
  for (let i = seconds; i > 0; i--) {
    countdownOverlay.textContent = i;
    countdownOverlay.style.transform = "translate(-50%, -50%) scale(1.2)";
    setTimeout(() => { countdownOverlay.style.transform = "translate(-50%, -50%) scale(1)"; }, 150);
    await sleep(1000);
  }
  countdownOverlay.classList.add("hidden");
}

function triggerScreenFlash() {
  flashOverlay.style.transition = "none";
  flashOverlay.style.opacity = "1";
  setTimeout(() => {
    flashOverlay.style.transition = "opacity 0.5s ease-out";
    flashOverlay.style.opacity = "0";
  }, 100);
}

shutterBtn.onclick = async () => {
  const layout = LAYOUTS[currentLayoutKey];
  const timerVal = TIMERS[currentTimerKey].value;
  capturedPhotos = [];
  
  shutterBtn.disabled = true;
  mainControls.style.opacity = "0.5";
  mainControls.style.pointerEvents = "none";
  
  if (layout.count > 1) {
    sequenceIndicator.classList.remove("hidden");
  }

  for (let i = 0; i < layout.count; i++) {
    if (layout.count > 1) {
      sequenceIndicator.textContent = `Frame ${i + 1} / ${layout.count}`;
    }
    
    // Check if the timer is turned on
    if (timerVal > 0) {
      await doCountdown(timerVal);
    } else {
      // If timer is OFF, we still need a tiny 1-second delay between multiple shots so people can move!
      if (i > 0) {
        await sleep(1000);
      }
    }
    
    if (flashEnabled) {
      triggerScreenFlash();
      await sleep(150);
    }

    const frameCanvas = grabSingleFrame(layout);
    capturedPhotos.push(frameCanvas);

    const img = document.createElement("img");
    img.src = frameCanvas.toDataURL("image/jpeg", 0.9);

    const currentSlot = document.getElementById(`slot-${i}`);
    
    // Safety check - put image precisely in current slot covering video
    currentSlot.appendChild(img);

    // Jump video to next slot cleanly
    if (i + 1 < layout.count) {
      const nextSlot = document.getElementById(`slot-${i + 1}`);
      nextSlot.appendChild(video);
      nextSlot.appendChild(videoOverlay);
      
      // Additional visual delay so the user can see their photo drop into the slot
      await sleep(600); 
    } else {
      video.classList.add('hidden');
      videoOverlay.classList.add('hidden');
    }
  }

  sequenceIndicator.classList.add("hidden");
  
  buildComposition(capturedPhotos, layout);
  
  mainControls.classList.add("hidden");
  uploadControls.classList.remove("hidden");
};

/* ================= PERFECT CENTER CROP MATH ================= */
function grabSingleFrame(layout) {
  const isSquare = layout.crop === 'square';
  const cW = 720;
  const cH = isSquare ? 720 : 960;

  const offCanvas = document.createElement("canvas");
  offCanvas.width = cW;
  offCanvas.height = cH;
  const octx = offCanvas.getContext("2d");

  if (facingMode === "user") {
    octx.translate(cW, 0);
    octx.scale(-1, 1);
  }
  
  octx.filter = FILTERS[currentFilterKey].css;

  // Calculates a perfect center crop preventing any stretching or warping
  const vW = video.videoWidth || 1080;
  const vH = video.videoHeight || 1440;
  const vRatio = vW / vH;
  const cRatio = cW / cH;

  let sX = 0, sY = 0, sW = vW, sH = vH;

  if (vRatio > cRatio) {
    sW = vH * cRatio;
    sX = (vW - sW) / 2;
  } else {
    sH = vW / cRatio;
    sY = (vH - sH) / 2;
  }

  octx.drawImage(video, sX, sY, sW, sH, 0, 0, cW, cH);
  octx.setTransform(1, 0, 0, 1, 0, 0);
  octx.filter = "none";

  const filter = FILTERS[currentFilterKey];
  if (filter.overlay !== 'transparent') {
    octx.fillStyle = filter.overlay;
    octx.fillRect(0, 0, cW, cH);
  }
  if (filter.vignette) {
    const v = octx.createRadialGradient(cW/2, cH/2, cW/4, cW/2, cH/2, Math.max(cW, cH));
    v.addColorStop(0, "rgba(0,0,0,0)");
    v.addColorStop(1, "rgba(0,0,0,0.5)");
    octx.fillStyle = v;
    octx.fillRect(0, 0, cW, cH);
  }
  
  return offCanvas;
}

/* ================= BUILD FINAL HIGH-RES UPLOAD ================= */
function buildComposition(photos, layout) {
  const frame = FRAMES[currentFrameKey];
  const pW = 720;
  const pH = layout.crop === 'square' ? 720 : 960; 
  const gap = 24;
  const outerPad = 32;
  const bottomSpace = 240; 

  canvas.width = (outerPad * 2) + (pW * layout.cols) + (gap * (layout.cols - 1));
  canvas.height = outerPad + bottomSpace + (pH * layout.rows) + (gap * (layout.rows - 1));

  ctx.fillStyle = frame.bgFill;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  photos.forEach((photoCanvas, i) => {
    const col = i % layout.cols;
    const row = Math.floor(i / layout.cols);
    const x = outerPad + col * (pW + gap);
    const y = outerPad + row * (pH + gap);
    
    ctx.drawImage(photoCanvas, x, y, pW, pH);
    
    ctx.strokeStyle = "rgba(0,0,0,0.04)";
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, pW, pH);
  });

  // Render High-Res Text
  ctx.textAlign = "center";
  ctx.fillStyle = frame.textCol;
  
  const textY = canvas.height - (bottomSpace * 0.45);
  ctx.font = `800 ${canvas.width * 0.05}px -apple-system, sans-serif`;
  ctx.fillText(EVENT_NAME.toUpperCase(), canvas.width / 2, textY);
  
  ctx.font = `500 ${canvas.width * 0.022}px -apple-system, sans-serif`;
  
  if(frame.bgFill === "#09090b") {
     ctx.fillStyle = 'rgba(255,255,255,0.5)';
  } else {
     ctx.fillStyle = 'rgba(0,0,0,0.4)';
  }
  ctx.fillText(EVENT_DATE.toUpperCase(), canvas.width / 2, textY + (canvas.width * 0.04));

  // Render High-Res Stickers onto the final canvas!
  if (frame.stickers) {
    frame.stickers.forEach(s => {
      ctx.font = `${canvas.width * s.size}px sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      let x = 0;
      let y = 0;
      if (s.left) x = canvas.width * (parseFloat(s.left) / 100);
      if (s.right) x = canvas.width - (canvas.width * (parseFloat(s.right) / 100));
      if (s.top) y = canvas.height * (parseFloat(s.top) / 100);
      if (s.bottom) y = canvas.height - (canvas.height * (parseFloat(s.bottom) / 100));

      ctx.save();
      ctx.translate(x, y);
      ctx.rotate((s.angle * Math.PI) / 180);
      
      // add shadow to sticker
      ctx.shadowColor = "rgba(0,0,0,0.1)";
      ctx.shadowBlur = canvas.width * 0.015;
      ctx.shadowOffsetY = canvas.width * 0.005;

      ctx.fillText(s.emoji, 0, 0);
      ctx.restore();
    });
  }
}

/* ================= UPLOAD & RETAKE ================= */
retakeBtn.onclick = () => {
  uploadControls.classList.add("hidden");
  document.getElementById("statusMessage").classList.add("hidden");
  
  applyLayout();
  mainControls.classList.remove("hidden");
  
  shutterBtn.disabled = false;
  mainControls.style.opacity = "1";
  mainControls.style.pointerEvents = "auto";
};

uploadBtn.onclick = async () => {
  uploadBtn.disabled = true;
  retakeBtn.disabled = true;
  const statusMessage = document.getElementById("statusMessage");
  statusMessage.className = "loading";
  statusMessage.textContent = "Processing gallery upload...";
  statusMessage.classList.remove("hidden");

  try {
    const blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", 0.9));
    const base64 = await new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result.split(",")[1]);
      reader.onerror = rej;
      reader.readAsDataURL(blob);
    });

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 35000); 

    const res = await fetch(UPLOAD_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      signal: controller.signal,
      body: JSON.stringify({
        file: base64,
        filename: `snapback_${Date.now()}.jpg`,
        mimeType: "image/jpeg"
      })
    });
    
    clearTimeout(timeout);
    if (!res.ok) throw new Error("Server error");
    await res.text();

    statusMessage.className = "success";
    statusMessage.textContent = "Upload complete.";
    uploadControls.classList.add("hidden");

    setTimeout(() => {
      retakeBtn.onclick(); 
      uploadBtn.disabled = false;
      retakeBtn.disabled = false;
    }, 2500);

  } catch (err) {
    statusMessage.className = "error";
    statusMessage.textContent = "Upload failed. Please check connection.";
    uploadBtn.disabled = false;
    retakeBtn.disabled = false;
  }
};

/* Start up */
initUI();
</script>

</body>
</html>
