 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>SNAPBACK Lite</title>

<style>
:root {
  --bg: #f6efe9;
  --accent: #d87c6a;
  --dark: #2f2f2f;
}

* {
  box-sizing: border-box;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--dark);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

header {
  text-align: center;
  margin-bottom: 6px;
}

h1 {
  margin: 0;
  letter-spacing: 2px;
}

.tagline {
  font-size: 12px;
  opacity: 0.7;
}

video, canvas {
  width: 100%;
  max-width: 420px;
  border-radius: 12px;
  background: black;
}

.controls {
  display: flex;
  gap: 8px;
  margin: 10px 0;
  flex-wrap: wrap;
  justify-content: center;
}

button {
  padding: 10px 14px;
  border-radius: 18px;
  border: none;
  background: #fff;
  font-size: 13px;
}

button.primary {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: var(--accent);
  color: white;
  font-size: 22px;
}

.hidden {
  display: none;
}

/* ===== STATUS MESSAGE ===== */
#statusMessage {
  margin-top: 10px;
  padding: 10px 14px;
  border-radius: 14px;
  font-size: 14px;
  text-align: center;
  max-width: 280px;
}

#statusMessage.loading {
  background: #fff3cd;
  color: #856404;
}

#statusMessage.success {
  background: #d4edda;
  color: #155724;
}

#statusMessage.error {
  background: #f8d7da;
  color: #721c24;
}
</style>
</head>

<body>

<header>
  <h1>SNAPBACK</h1>
  <div class="tagline">Old-school vibes. New memories.</div>
</header>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" class="hidden"></canvas>

<div class="controls">
  <button id="photoBtn">üì∏ Photo</button>
  <button id="videoBtn">üé• Video</button>
</div>

<div class="controls">
  <button data-filter="warm">Warm</button>
  <button data-filter="grain">Grain</button>
  <button data-filter="soft">Soft</button>
  <button data-filter="none">None</button>
</div>

<button id="shutter" class="primary">‚óè</button>

<div class="controls hidden" id="uploadControls">
  <button id="uploadBtn">Upload</button>
</div>

<div id="statusMessage" class="hidden"></div>

<script>
/* ================= CONFIG ================= */
const UPLOAD_URL =
"https://script.google.com/macros/s/AKfycbxX9wMOWPLZrimEpvdojQsOh6ESW8kgBw3BK_qYX6VJC8s05tKgYS7BqrnULgrFS5zB/exec";

/* ================= ELEMENTS ================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const photoBtn = document.getElementById("photoBtn");
const videoBtn = document.getElementById("videoBtn");
const shutter = document.getElementById("shutter");
const uploadControls = document.getElementById("uploadControls");
const uploadBtn = document.getElementById("uploadBtn");
const statusMessage = document.getElementById("statusMessage");
const filterButtons = document.querySelectorAll("[data-filter]");

/* ================= STATE ================= */
let stream = null;
let recorder = null;
let chunks = [];
let recordedBlob = null;
let mode = "photo";
let currentFilter = "warm";

/* ================= CAMERA ================= */
async function startCamera(audio = false) {
  if (stream) stream.getTracks().forEach(t => t.stop());

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio
    });
    video.srcObject = stream;
  } catch {
    alert("Camera permission is required.");
  }
}

startCamera(false);

/* ================= MODE ================= */
photoBtn.onclick = () => {
  mode = "photo";
  resetView();
  startCamera(false);
};

videoBtn.onclick = () => {
  mode = "video";
  resetView();
  startCamera(true);
};

/* ================= FILTER ================= */
filterButtons.forEach(btn => {
  btn.onclick = () => currentFilter = btn.dataset.filter;
});

/* ================= SHUTTER ================= */
shutter.onclick = () => {
  if (mode === "photo") takePhoto();
  else recordVideo();
};

/* ================= PHOTO ================= */
function takePhoto() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video, 0, 0);
  applyFilter();
  drawDate();

  video.classList.add("hidden");
  canvas.classList.remove("hidden");
  uploadControls.classList.remove("hidden");
}

function applyFilter() {
  if (currentFilter === "warm") {
    ctx.fillStyle = "rgba(255,180,130,0.12)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  if (currentFilter === "grain") {
    ctx.globalAlpha = 0.15;
    for (let i = 0; i < 2500; i++) {
      ctx.fillStyle = `rgb(${Math.random()*255},${Math.random()*255},${Math.random()*255})`;
      ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 1, 1);
    }
    ctx.globalAlpha = 1;
  }

  if (currentFilter === "soft") {
    ctx.fillStyle = "rgba(255,255,255,0.08)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  const v = ctx.createRadialGradient(
    canvas.width/2, canvas.height/2, canvas.width/4,
    canvas.width/2, canvas.height/2, canvas.width/1.1
  );
  v.addColorStop(0,"rgba(0,0,0,0)");
  v.addColorStop(1,"rgba(0,0,0,0.45)");
  ctx.fillStyle = v;
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function drawDate() {
  ctx.font = "16px monospace";
  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.fillText(
    new Date().toLocaleDateString(),
    canvas.width - 120,
    canvas.height - 20
  );
}

/* ================= VIDEO ================= */
function recordVideo() {
  chunks = [];
  recorder = new MediaRecorder(stream);
  recorder.start();

  setTimeout(() => recorder.stop(), 6000);

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    recordedBlob = new Blob(chunks, { type: "video/mp4" });
    uploadControls.classList.remove("hidden");
  };
}

/* ================= UPLOAD (HANG-PROOF) ================= */
uploadBtn.onclick = async () => {
  uploadBtn.disabled = true;
  statusMessage.className = "loading";
  statusMessage.textContent = "Uploading‚Ä¶";
  statusMessage.classList.remove("hidden");

  try {
    let blob, mime, ext;

    if (mode === "photo") {
      blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", 0.85));
      mime = "image/jpeg";
      ext = "jpg";
    } else {
      if (!recordedBlob) throw new Error("No video recorded");
      blob = recordedBlob;
      mime = "video/mp4";
      ext = "mp4";
    }

    const base64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(",")[1]);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 12000);

    const res = await fetch(UPLOAD_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      signal: controller.signal,
      body: JSON.stringify({
        file: base64,
        filename: `snapback_${Date.now()}.${ext}`,
        mimeType: mime
      })
    });

    clearTimeout(timeout);

    if (!res.ok) throw new Error("Server error");

    // üîë DO NOT PARSE JSON ‚Äî THIS PREVENTS HANGING
    await res.text();

    statusMessage.className = "success";
    statusMessage.textContent = "‚úÖ Upload complete! Thank you üíñ";
    uploadControls.classList.add("hidden");

    setTimeout(() => {
      resetView();
      startCamera(mode === "video");
    }, 2000);

  } catch (err) {
    console.error(err);
    statusMessage.className = "error";
    statusMessage.textContent =
      err.name === "AbortError"
        ? "‚ùå Upload timed out. Please try again."
        : "‚ùå Upload failed. Please try again.";
    uploadBtn.disabled = false;
  }
};


/* ================= RESET ================= */
function resetView() {
  uploadControls.classList.add("hidden");
  statusMessage.classList.add("hidden");
  canvas.classList.add("hidden");
  video.classList.remove("hidden");
  uploadBtn.disabled = false;
}
</script>

</body>
</html>
